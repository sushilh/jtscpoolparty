
<!DOCTYPE html>
<html>
<head>
  <title>Event Check-In</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --primary-color: #7D2248;
      --background-light: #ffffff;
      --background-dark: #1c1c1e;
      --text-light: #000000;
      --text-dark: #ffffff;
    }

    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 1rem;
      background-color: var(--background-light);
      color: var(--text-light);
      transition: background-color 0.3s, color 0.3s;
    }

    body.dark-mode {
      background-color: var(--background-dark);
      color: var(--text-dark);
    }

    h1 {
      text-align: center;
      color: var(--primary-color);
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .controls input, .controls select, .controls button {
      padding: 0.5rem;
      font-size: 1rem;
    }

    .toggle-mode {
      cursor: pointer;
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 5px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 1rem;
    }

    th, td {
      padding: 0.75rem;
      border: 1px solid #ccc;
      text-align: center;
    }

    td .actions {
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
    }

    @media (max-width: 600px) {
      table, thead, tbody, th, td, tr {
        display: block;
      }
      thead tr {
        display: none;
      }
      td {
        position: relative;
        padding-left: 50%;
        margin-bottom: 10px;
        background: #f9f9f9;
        border-radius: 8px;
        margin-top: 8px;
      }
      td::before {
        content: attr(data-label);
        position: absolute;
        left: 10px;
        font-weight: bold;
        color: var(--primary-color);
      }
    }
  </style>
</head>
<body>
  <h1>Event Check-In</h1>
  <div class="controls">
    <input type="text" id="search" placeholder="üîç Search swimmer name..." oninput="filterTable()">
    <select id="status-filter" onchange="filterTable()">
      <option value="all">All</option>
      <option value="checkedin">Checked-In</option>
      <option value="notcheckedin">Not Checked-In</option>
    </select>
    <button onclick="exportCSV()">‚¨áÔ∏è Export CSV</button>
    <button class="toggle-mode" onclick="toggleMode()">üåì Toggle Mode</button>
  </div>
  <table id="attendee-table"></table>

  <script>
    let allAttendees = [];

    async function loadAttendees() {
      const res = await fetch('/attendees');
      allAttendees = await res.json();
      renderTable(allAttendees);
    }

    function renderTable(data) {
      const table = document.getElementById('attendee-table');
      table.innerHTML = '<thead><tr><th>Name</th><th>Email</th><th>Total Guests</th><th>Checked In</th><th>Guests Checked In</th><th>Action</th></tr></thead><tbody>';
      data.forEach(a => {
        const checked = a.checked_in ? '‚úÖ' : '‚ùå';
        const guests = a.guests_checked_in ?? '-';
        const actions = a.checked_in
          ? `<button onclick="uncheckIn(${a.id})">Undo</button>`
          : `<input type="number" min="1" max="${a.total_guests}" id="guests_${a.id}" placeholder="#"><button onclick="checkIn(${a.id})">Check In</button>`;
        table.innerHTML += `
          <tr data-status="${a.checked_in ? 'checkedin' : 'notcheckedin'}" data-name="${a.swimmer_name.toLowerCase()}">
            <td data-label="Name">${a.swimmer_name}</td>
            <td data-label="Email">${a.parent_email}</td>
            <td data-label="Total Guests">${a.total_guests}</td>
            <td data-label="Checked In">${checked}</td>
            <td data-label="Guests Checked In">${guests}</td>
            <td data-label="Action"><div class="actions">${actions}</div></td>
          </tr>`;
      });
      table.innerHTML += '</tbody>';
    }

    function filterTable() {
      const keyword = document.getElementById('search').value.toLowerCase();
      const status = document.getElementById('status-filter').value;
      const rows = document.querySelectorAll('#attendee-table tbody tr');

      rows.forEach(row => {
        const nameMatch = row.dataset.name.includes(keyword);
        const statusMatch = (status === 'all') || (row.dataset.status === status);
        row.style.display = nameMatch && statusMatch ? '' : 'none';
      });
    }

    async function checkIn(id) {
      const input = document.getElementById('guests_' + id);
      const guests_checked_in = parseInt(input.value);
      if (isNaN(guests_checked_in) || guests_checked_in < 1) {
        alert('Please enter a valid number of guests.');
        return;
      }
      await fetch('/checkin/' + id, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ guests_checked_in })
      });
      loadAttendees();
    }

    async function uncheckIn(id) {
      await fetch('/uncheckin/' + id, { method: 'POST' });
      loadAttendees();
    }

    function exportCSV() {
      window.location.href = '/export';
    }

    function toggleMode() {
      document.body.classList.toggle('dark-mode');
    }

    loadAttendees();
    setInterval(loadAttendees, 10000);
  </script>
</body>
</html>
